<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI to Penpot</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>ðŸ¤– AI to Penpot</h1>
      <p>Transform JSON into real designs</p>
    </header>

    <main>
      <!-- JSON Input Section -->
      <section class="input-section">
        <label for="jsonInput">Paste your JSON here:</label>
        <textarea
          id="jsonInput"
          placeholder='{
  "frame": { "name": "Login Screen", "width": 375, "height": 667 },
  "components": [
    { "type": "text", "text": "Welcome", "x": 24, "y": 32 }
  ]
}'
          rows="15"
        ></textarea>
      </section>

      <!-- File Upload Alternative -->
      <section class="upload-section">
        <p>Or upload a JSON file:</p>
        <input type="file" id="fileInput" accept=".json">
      </section>

      <!-- Preview Section -->
      <section class="preview-section">
        <h3>Preview</h3>
        <div id="preview" class="preview-box">
          <p class="placeholder">JSON preview will appear here...</p>
        </div>
      </section>

      <!-- Actions -->
      <section class="actions">
        <button id="validateBtn" class="btn btn-secondary">
          Validate JSON
        </button>
        <button id="generateBtn" class="btn btn-primary">
          Generate Design
        </button>
      </section>

      <!-- Status Messages -->
      <div id="status" class="status"></div>
    </main>
  </div>

  <script>
    // DOM Elements
    const jsonInput = document.getElementById('jsonInput');
    const fileInput = document.getElementById('fileInput');
    const validateBtn = document.getElementById('validateBtn');
    const generateBtn = document.getElementById('generateBtn');
    const preview = document.getElementById('preview');
    const status = document.getElementById('status');

    let currentJSON = null;

    // Event listeners
    validateBtn.addEventListener('click', validateJSON);
    generateBtn.addEventListener('click', generateDesign);
    fileInput.addEventListener('change', handleFileUpload);
    jsonInput.addEventListener('input', updatePreview);

    // Handle messages from code.js
    window.addEventListener('message', (event) => {
      const message = event.data;

      if (message.type === 'generation-complete') {
        if (message.success) {
          showStatus(`ðŸŽ‰ Success! Created ${message.count} components`, 'success');
        } else {
          showStatus(`âŒ Error: ${message.error}`, 'error');
        }
      }
    });

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        jsonInput.value = e.target.result;
        updatePreview();
      };
      reader.readAsText(file);
    }

    function updatePreview() {
      try {
        const data = JSON.parse(jsonInput.value);
        currentJSON = data;

        const componentCount = data.components?.length || 0;
        const frameName = data.frame?.name || 'Unnamed';

        preview.innerHTML = `
          <strong>Frame:</strong> ${frameName}<br>
          <strong>Components:</strong> ${componentCount}<br>
          <strong>Valid:</strong> âœ… Ready to generate
        `;
      } catch (error) {
        preview.innerHTML = `<p class="placeholder">Invalid JSON - check syntax</p>`;
        currentJSON = null;
      }
    }

    function validateJSON() {
      try {
        const data = JSON.parse(jsonInput.value);

        if (!data.frame) {
          throw new Error('Missing "frame" property');
        }
        if (!data.components || !Array.isArray(data.components)) {
          throw new Error('Missing or invalid "components" array');
        }

        currentJSON = data;
        showStatus('âœ… JSON is valid!', 'success');
        updatePreview();
      } catch (error) {
        showStatus(`âŒ Validation error: ${error.message}`, 'error');
      }
    }

    function generateDesign() {
      if (!currentJSON) {
        showStatus('âŒ Please enter valid JSON first', 'error');
        return;
      }

      showStatus('ðŸ”„ Generating design...', 'info');

      // Send message to code.js (which has access to penpot API)
      window.parent.postMessage({
        type: 'generate-design',
        data: currentJSON
      }, '*');
    }

    function showStatus(message, type) {
      status.textContent = message;
      status.className = `status show ${type}`;

      setTimeout(() => {
        status.classList.remove('show');
      }, 5000);
    }

    console.log('âœ¨ Plugin UI initialized!');
  </script>
</body>
</html>
